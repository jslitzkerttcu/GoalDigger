<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoalDigger Chat Widget</title>
    <!-- Deployment trigger v4 -->
    <link rel="stylesheet" href="css/widget.css">
</head>
<body>
    <!-- GoalDigger Chat Widget Only -->
    <div id="goaldigger-widget" class="gd-widget">
        <div class="gd-header">
            <span class="gd-title">‚õèÔ∏è Goal Digger Chat</span>
            <button class="gd-clear" onclick="GoalDigger.clearChat()" title="Start new conversation">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18v2h-20v-2h5.711c.9 0 1.631-1.099 1.631-2h5.315c0 .901.73 2 1.631 2h5.712z"/>
                </svg>
                <span>New Chat</span>
            </button>
            <button class="gd-minimize" onclick="GoalDigger.toggle()">_</button>
        </div>
        
        <div class="gd-messages" id="gd-messages">
            <!-- Messages appear here -->
        </div>
        
        <div class="gd-context-vault" id="gd-vault" style="display: none;">
            <div class="vault-header">
                <strong>üîí Context Vault</strong>
                <button onclick="GoalDigger.hideVault()">‚úï</button>
            </div>
            <pre id="vault-content">{}</pre>
        </div>
        
        <div class="gd-input-area">
            <input 
                type="text" 
                id="gd-input" 
                placeholder="Ask about your savings plan..."
                onkeypress="if(event.key==='Enter') GoalDigger.sendMessage()"
            />
            <button onclick="GoalDigger.sendMessage()">Send</button>
        </div>
    </div>

    <!-- Chart Modal -->
    <div id="chart-modal" class="chart-modal" style="display: none;">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <h3>Chart Details</h3>
                <div class="modal-controls">
                    <button class="modal-download-btn" onclick="GoalDigger.downloadModalChart()" title="Download as PDF">
                        üìä Download PDF
                    </button>
                    <button class="chart-modal-close" onclick="GoalDigger.closeChartModal()">&times;</button>
                </div>
            </div>
            <div class="chart-modal-body">
                <canvas id="modal-chart-canvas"></canvas>
            </div>
        </div>
    </div>

    <!-- Chart.js Library - try older stable version -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- jsPDF for PDF generation - direct ES5 version -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
    <script>
        // Debug Chart.js loading
        console.log('Checking Chart.js availability...');
        if (typeof Chart !== 'undefined') {
            console.log('Chart.js loaded successfully, version:', Chart.version);
        } else {
            console.error('Chart.js failed to load from CDN');
            // Try alternative CDN
            var script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
            script.onload = function() { console.log('Chart.js loaded from cdnjs fallback'); };
            script.onerror = function() { console.error('All Chart.js CDNs failed'); };
            document.head.appendChild(script);
        }
        
        // Debug jsPDF loading
        console.log('Checking jsPDF availability...');
        setTimeout(function() {
            console.log('window.jsPDF:', typeof window.jsPDF);
            if (typeof window.jsPDF !== 'undefined') {
                console.log('jsPDF v1.5.3 loaded successfully');
                // Test creating a PDF instance
                try {
                    var testPdf = new jsPDF();
                    console.log('jsPDF constructor works correctly');
                } catch (e) {
                    console.error('jsPDF constructor failed:', e);
                }
            } else {
                console.error('jsPDF v1.5.3 failed to load');
            }
        }, 100);
    </script>
    <script src="js/widget.js"></script>
</body>
</html>